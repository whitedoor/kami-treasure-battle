<div class="ktb-page" style="place-items: start; padding-top: 22px;">
  <div style="width: 100%;">
    <div class="ktb-note" style="max-width: 980px; margin: 0 auto 14px; text-align: left;">
      <div style="font-weight: 900; font-size: 18px; opacity: 0.95;">CPUバトル（じゃんけん）</div>
      <div style="opacity: 0.85; margin-top: 6px;">
        勝った側が攻撃（カードの攻撃力分）。あいこは両者 <b><%= @battle_state[:tie_damage] %></b> ダメージ。
      </div>
    </div>

    <div class="ktb-box" style="max-width: 980px; margin: 0 auto;">
      <div class="ktb-title">バトル状況</div>

      <div style="display: grid; gap: 10px;">
        <div style="display:flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
          <div>
            <b>あなた</b>: HP <b><%= @battle_state[:player_hp] %></b> / <%= @battle_state[:initial_hp] %>
          </div>
          <div>
            <b>CPU</b>: HP <b><%= @battle_state[:cpu_hp] %></b> / <%= @battle_state[:initial_hp] %>
          </div>
        </div>

        <% last_turn = @battle_state[:turns]&.last %>
        <% if last_turn.present? %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.9;">
            <div style="font-weight: 900; opacity: 0.95;">直前ターン</div>
            <div style="margin-top: 6px;">
              あなた: <b><%= last_turn[:player_hand] %></b> / CPU: <b><%= last_turn[:cpu_hand] %></b> /
              結果: <b><%= last_turn[:outcome] %></b>
            </div>
            <div style="margin-top: 4px;">
              あなた被ダメ: <b><%= last_turn[:player_damage] %></b> / CPU被ダメ: <b><%= last_turn[:cpu_damage] %></b>
            </div>
          </div>
        <% end %>

        <% if @battle_state[:ended] %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.95;">
            <div style="font-weight: 900;">決着</div>
            <div style="margin-top: 6px;">
              勝者: <b><%= @battle_state[:winner] %></b>
            </div>
          </div>

          <div class="ktb-actions" style="justify-content: flex-start;">
            <%= button_to "もう一度（リセット）", battle_path, method: :delete, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= link_to "ロードアウトを選び直す", new_battle_path, class: "ktb-pill" %>
          </div>
        <% else %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.9;">
            <div style="font-weight: 900; opacity: 0.95;">出す手を選択</div>
            <div style="margin-top: 6px; opacity: 0.9;">
              グー/チョキ/パーのボタンを押すと1ターン進みます。
            </div>
          </div>

          <div class="ktb-actions" style="justify-content: flex-start;">
            <%= button_to "✊ グー", turn_battle_path(hand: "gu"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "✌️ チョキ", turn_battle_path(hand: "choki"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "🖐️ パー", turn_battle_path(hand: "pa"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "リセット", battle_path, method: :delete, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

