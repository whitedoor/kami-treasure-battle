<div class="ktb-page" style="place-items: start; padding-top: 22px;">
  <div style="width: 100%;">
    <div class="ktb-note" style="max-width: none; width: 100%; margin: 0 0 14px; text-align: left;">
      <div style="font-weight: 900; font-size: 18px; opacity: 0.95;">CPUãƒãƒˆãƒ«ï¼ˆã˜ã‚ƒã‚“ã‘ã‚“ï¼‰</div>
      <div style="opacity: 0.85; margin-top: 6px;">
        å‹ã£ãŸå´ãŒæ”»æ’ƒï¼ˆã‚«ãƒ¼ãƒ‰ã®æ”»æ’ƒåŠ›åˆ†ï¼‰ã€‚ã‚ã„ã“ã¯ä¸¡è€… <b><%= @battle_state[:tie_damage] %></b> ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚
      </div>
    </div>

    <div class="ktb-box" style="max-width: none; width: 100%; margin: 0;">
      <div class="ktb-title">ãƒãƒˆãƒ«çŠ¶æ³</div>

      <div style="display: grid; gap: 10px;">
        <% last_turn = @battle_state[:turns]&.last %>

        <% initial_hp = @battle_state[:initial_hp].to_i %>
        <% player_hp = @battle_state[:player_hp].to_i %>
        <% cpu_hp = @battle_state[:cpu_hp].to_i %>

        <% hand_label = { "gu" => "ã‚°ãƒ¼", "choki" => "ãƒãƒ§ã‚­", "pa" => "ãƒ‘ãƒ¼" } %>
        <% hand_emoji = { "gu" => "âœŠ", "choki" => "âœŒï¸", "pa" => "ğŸ–ï¸" } %>
        <% outcome_label = { "player" => "ã‚ãªãŸã®å‹ã¡", "cpu" => "CPUã®å‹ã¡", "tie" => "ã‚ã„ã“" } %>
        <% winner_label = { "player" => "ã‚ãªãŸ", "cpu" => "CPU", "draw" => "å¼•ãåˆ†ã‘" } %>

        <% player_pct = initial_hp.positive? ? ((player_hp.to_f / initial_hp) * 100).round : 0 %>
        <% cpu_pct = initial_hp.positive? ? ((cpu_hp.to_f / initial_hp) * 100).round : 0 %>
        <% player_pct = [[player_pct, 0].max, 100].min %>
        <% cpu_pct = [[cpu_pct, 0].max, 100].min %>

        <% player_tier = player_pct >= 60 ? "high" : (player_pct >= 30 ? "mid" : "low") %>
        <% cpu_tier = cpu_pct >= 60 ? "high" : (cpu_pct >= 30 ? "mid" : "low") %>

        <div
          class="ktb-battle"
          data-controller="battle-effect"
          data-battle-effect-outcome-value="<%= last_turn&.dig(:outcome).to_s %>"
          data-battle-effect-player-damage-value="<%= last_turn&.dig(:player_damage).to_i %>"
          data-battle-effect-cpu-damage-value="<%= last_turn&.dig(:cpu_damage).to_i %>"
          data-battle-effect-ended-value="<%= !!@battle_state[:ended] %>"
          data-battle-effect-winner-value="<%= @battle_state[:winner].to_s %>"
        >
          <div class="ktb-battleBanner" data-battle-effect-target="banner" aria-live="polite"></div>
          <div class="ktb-battleEndBanner" data-battle-effect-target="endBanner" aria-live="polite"></div>

          <div class="ktb-hpGrid">
            <div class="ktb-hpSide ktb-hpSide--player" data-battle-effect-target="playerSide">
              <div class="ktb-hpTop">
                <div class="ktb-hpName"><b>ã‚ãªãŸ</b></div>
                <div class="ktb-hpNumbers">HP <b><%= player_hp %></b> / <%= initial_hp %></div>
              </div>
              <div class="ktb-hpBar ktb-hpBar--<%= player_tier %>" style="--ktb-hp-pct: <%= player_pct %>%;">
                <div class="ktb-hpFill"></div>
              </div>
            </div>

            <div class="ktb-hpSide ktb-hpSide--cpu" data-battle-effect-target="cpuSide">
              <div class="ktb-hpTop">
                <div class="ktb-hpName"><b>CPU</b></div>
                <div class="ktb-hpNumbers">HP <b><%= cpu_hp %></b> / <%= initial_hp %></div>
              </div>
              <div class="ktb-hpBar ktb-hpBar--<%= cpu_tier %>" style="--ktb-hp-pct: <%= cpu_pct %>%;">
                <div class="ktb-hpFill"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="ktb-battleLoadouts" aria-label="ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆé¸æŠã‚«ãƒ¼ãƒ‰ï¼‰">
          <% hands = %w[gu choki pa] %>

          <div class="ktb-battleLoadouts__col" aria-label="ã‚ãªãŸã®ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ">
            <div class="ktb-battleLoadouts__title">ã‚ãªãŸã®ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ</div>
            <div class="ktb-battleLoadouts__grid">
              <% hands.each do |hand| %>
                <%= render partial: "mini_card", locals: { card: @player_cards[hand] } %>
              <% end %>
            </div>
          </div>

          <div class="ktb-battleLoadouts__col" aria-label="CPUã®ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ">
            <div class="ktb-battleLoadouts__title">CPUã®ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ</div>
            <div class="ktb-battleLoadouts__grid">
              <% hands.each do |hand| %>
                <%= render partial: "mini_card", locals: { card: @cpu_cards[hand] } %>
              <% end %>
            </div>
          </div>
        </div>

        <% if last_turn.present? %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.9;">
            <div style="font-weight: 900; opacity: 0.95;">ç›´å‰ã‚¿ãƒ¼ãƒ³</div>
            <div style="margin-top: 6px;">
              ã‚ãªãŸ: <b><%= hand_emoji[last_turn[:player_hand].to_s] %> <%= hand_label[last_turn[:player_hand].to_s] || last_turn[:player_hand] %></b> /
              CPU: <b><%= hand_emoji[last_turn[:cpu_hand].to_s] %> <%= hand_label[last_turn[:cpu_hand].to_s] || last_turn[:cpu_hand] %></b> /
              çµæœ: <b><%= outcome_label[last_turn[:outcome].to_s] || last_turn[:outcome] %></b>
            </div>
            <div style="margin-top: 4px;">
              ã‚ãªãŸè¢«ãƒ€ãƒ¡: <b><%= last_turn[:player_damage] %></b> / CPUè¢«ãƒ€ãƒ¡: <b><%= last_turn[:cpu_damage] %></b>
            </div>
          </div>
        <% end %>

        <% if @battle_state[:ended] %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.95;">
            <div style="font-weight: 900;">æ±ºç€</div>
            <div style="margin-top: 6px;">
              å‹è€…: <b><%= winner_label[@battle_state[:winner].to_s] || @battle_state[:winner] %></b>
            </div>
          </div>

          <div class="ktb-actions" style="justify-content: flex-start;">
            <%= link_to "ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚’é¸ã³ç›´ã™", new_battle_path, class: "ktb-pill" %>
          </div>
        <% else %>
          <div class="ktb-note" style="max-width: 980px; margin: 0; text-align: left; opacity: 0.9;">
            <div style="font-weight: 900; opacity: 0.95;">å‡ºã™æ‰‹ã‚’é¸æŠ</div>
            <div style="margin-top: 6px; opacity: 0.9;">
              ã‚°ãƒ¼/ãƒãƒ§ã‚­/ãƒ‘ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨1ã‚¿ãƒ¼ãƒ³é€²ã¿ã¾ã™ã€‚
            </div>
          </div>

          <div class="ktb-actions" style="justify-content: flex-start;">
            <%= button_to "âœŠ ã‚°ãƒ¼", turn_battle_path(hand: "gu"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "âœŒï¸ ãƒãƒ§ã‚­", turn_battle_path(hand: "choki"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "ğŸ–ï¸ ãƒ‘ãƒ¼", turn_battle_path(hand: "pa"), method: :post, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
            <%= button_to "ãƒªã‚»ãƒƒãƒˆ", battle_path, method: :delete, class: "ktb-pill", form: { style: "display:inline;", data: { turbo: false } } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

