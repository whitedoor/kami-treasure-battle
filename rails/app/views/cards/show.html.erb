<div class="ktb-page">
  <div>
    <div class="ktb-note" style="margin-bottom: 12px;">
      <a href="<%= receipt_upload_path(@card.receipt_upload) %>" class="ktb-pill">← ReceiptUpload に戻る</a>
    </div>

    <div class="ktb-note" style="margin-bottom: 12px;">
      <div style="font-weight: 800; margin-bottom: 6px;">生成AI画像（Imagen）</div>
      <div style="opacity: 0.9;">
        状態: <b><%= @card.artwork_status %></b>
        <% if @card.artwork_error.present? %>
          <span style="color: #ffb4b4;">（<%= @card.artwork_error %>）</span>
        <% end %>
      </div>
      <div style="margin-top: 10px;">
        <% if @card.artwork_status == "generated" %>
          <span class="ktb-pill" aria-disabled="true">生成済み</span>
        <% elsif @card.artwork_status == "generating" %>
          <span class="ktb-pill" aria-disabled="true">生成中…</span>
        <% else %>
          <%= button_to "生成AIで画像を生成する", generate_artwork_card_path(@card), method: :post, class: "ktb-pill" %>
        <% end %>
      </div>
    </div>

    <% is_starter_card = (@card.rarity == "normal") %>
    <% frame_theme =
         if is_starter_card
           case @card.hand
           when "gu" then "starter-gu"
           when "choki" then "starter-choki"
           when "pa" then "starter-pa"
           else "starter"
           end
         else
           case @card.rarity
           when "bronze", "silver", "gold", "legend" then @card.rarity
           else "normal"
           end
         end %>
    <div class="ktb-card" aria-label="カード表示">
      <div class="ktb-frame ktb-frame--ornate ktb-frame--<%= frame_theme %>">
        <div class="ktb-frame__inner">
          <% hand_emoji = (@card.hand == "gu" ? "✊" : (@card.hand == "choki" ? "✌️" : "🖐️")) %>
          <% hand_label = (@card.hand == "gu" ? "グー" : (@card.hand == "choki" ? "チョキ" : "パー")) %>
          <div class="ktb-card__header" aria-label="カード名とタイプ">
            <div class="ktb-badge ktb-badge--handTitle" aria-label="<%= hand_label %>" title="<%= hand_label %>">
              <span><%= hand_emoji %></span>
            </div>
            <div class="ktb-card__title"><%= @card.name %></div>
            <div class="ktb-card__headerSpacer" aria-hidden="true"></div>
          </div>

          <div class="ktb-card__art">
            <div class="ktb-card__artSquare" aria-label="画像（正方形トリミング表示）">
              <img
                src="<%= image_card_path(@card) %>"
                alt="card image"
                class="ktb-card__artImage"
                loading="lazy"
                decoding="async"
              >
            </div>
          </div>

          <div class="ktb-card__footer">
            <div class="ktb-card__attack" aria-label="攻撃力">
              攻撃力 <span class="ktb-card__attackValue"><%= @card.attack_power %></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="ktb-note">
      <div><b>フレーバー</b>: <%= @card.flavor %></div>
      <div><b>レアリティ</b>: <%= @card.rarity %></div>
      <div style="margin-top: 8px; opacity: 0.95;">
        画像は <code><%= image_card_path(@card) %></code> で表示しています（生成済みならGCSから取得）。
      </div>
    </div>
  </div>
</div>

